<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generador de Comprobantes de Pago Telcel</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 30px;
    }

    .form-section, .preview-section {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .form-section h2, .preview-section h2 {
      color: #333; margin-bottom: 20px; text-align: center; font-size: 24px;
    }

    .form-group { margin-bottom: 20px; }
    label { display:block; margin-bottom:5px; font-weight:bold; color:#555; }

    input, select {
      width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;
      font-size: 16px; transition: border-color .3s ease; text-transform: uppercase;
    }
    input:focus, select:focus { outline:none; border-color:#667eea; }

    button {
      width: 100%; padding: 15px; background: linear-gradient(45deg, #667eea, #764ba2);
      color:white; border:none; border-radius:8px; font-size:18px; cursor:pointer;
      transition: transform .2s ease; margin-bottom:10px;
    }
    .pdf-button { background: linear-gradient(45deg, #e74c3c, #c0392b); }
    button:hover { transform: translateY(-2px); }

    /* Comprobante A4 con UN solo borde exterior (en pantalla) */
    .comprobante {
      border: 2px solid #000;     /* ‚Üê borde de la hoja */
      background: white;
      font-size: 11px;
      line-height: 1.2;
      width: 210mm;
      min-height: 297mm;
      margin: 0 auto;
      padding: 0;
      box-sizing: border-box;
    }

    .header-section { padding: 20px 30px; }
    .header-top {
      display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px;
    }

    .logo-company-section { display:flex; align-items:flex-start; gap:20px; }
    .telcel-logo { width:180px; height:70px; display:flex; align-items:center; justify-content:center; }
    .telcel-logo img { width:100%; height:100%; object-fit:contain; }

    .company-info { font-size:11px; line-height:1.3; }
    .company-info h3 { font-size:13px; font-weight:bold; margin-bottom:5px; }

    .factura-box {
      border: 2px solid #000; padding:8px 15px; text-align:center; font-weight:bold; font-size:11px;
    }
    /* Cuadrito peque√±o SOLO alrededor del n√∫mero de factura */
    .nf-box {
      display: inline-block;
      border: 1px solid #000;
      padding: 2px 6px;
      margin-top: 4px;
      border-radius: 2px;
      letter-spacing: .5px;
    }

    .rfc-section { text-align:center; margin:15px 0; font-weight:bold; font-size:12px; }

    .client-section { padding: 0 30px; margin-bottom: 20px; }
    .client-row {
      display:grid; grid-template-columns:2fr 1fr 2fr; gap:30px; margin-bottom:15px;
    }
    .client-field { display:flex; gap:10px; align-items:baseline; }
    .client-field strong { min-width:80px; font-weight:bold; }

    .product-section { padding: 0 30px; margin-bottom: 20px; }
    .product-table {
      width:100%; border-collapse: collapse; border: 2px solid #000; margin-bottom:20px;
    }
    .product-table th, .product-table td {
      border:1px solid #000; padding:8px 5px; text-align:center; font-size:10px;
    }
    .product-table th { background:#f8f8f8; font-weight:bold; font-size:9px; }
    /* Segunda fila (IMEI 2) como referencia: sin precio/total, visual tenue */
    .product-table tr.ref td { background:#fafafa; font-style: italic; }

    .totals-section { padding: 0 30px; text-align: right; margin-bottom: 20px; }
    .totals-section div { margin-bottom: 5px; font-size: 11px; }

    .payment-section { padding: 0 30px 30px; border-top: 1px solid #000; padding-top: 15px; }
    .status-cancelled { color:red; font-weight:bold; font-size:12px; }

    @media (max-width: 1200px) {
      .container { grid-template-columns: 1fr; }
      .comprobante { width:100%; transform: scale(.8); transform-origin: top center; }
    }

    /* Exportaci√≥n/impresi√≥n: sin encabezados/pies y sin bordes internos */
    @page { size: A4; margin: 0; }
    @media print {
      html, body { margin:0 !important; padding:0 !important; background: white !important; }
      .comprobante {
        width: 210mm; min-height: 297mm;
        border: 2px solid #000 !important; margin: 0 !important; padding: 0 !important;
        -webkit-print-color-adjust: exact; print-color-adjust: exact;
      }
      /* Oculta bordes internos, pero deja el cuadrito del n√∫mero */
      .factura-box { border: none !important; }
      .product-table { border-color: transparent !important; }
      .product-table th, .product-table td { border-color: transparent !important; }
      .payment-section { border-top-color: transparent !important; }
      .nf-box { border: 1px solid #000 !important; }
    }

    /* Al exportar con html2pdf agregamos .exporting al <body> para simular los estilos @media print */
    body.exporting .factura-box { border: none !important; }
    body.exporting .product-table,
    body.exporting .product-table th,
    body.exporting .product-table td { border-color: transparent !important; }
    body.exporting .payment-section { border-top-color: transparent !important; }
    body.exporting .nf-box { border: 1px solid #000 !important; } /* mantener el cuadrito */
  </style>
</head>
<body>
  <div class="container">
    <div class="form-section">
      <h2>üìù Datos del Comprobante</h2>
      <form id="comprobanteForm" novalidate>
        <div class="form-group">
          <label for="dni">DNI / ID CID:</label>
          <input type="text" id="dni" name="dni" required />
        </div>

        <div class="form-group">
          <label for="nombreCliente">Nombre del Cliente:</label>
          <input type="text" id="nombreCliente" name="nombreCliente" required />
        </div>

        <div class="form-group">
          <label for="imei1">IMEI 1 (Serie):</label>
          <input type="text" id="imei1" name="imei1" required />
        </div>

        <div class="form-group">
          <label for="imei2">IMEI 2 (Serie):</label>
          <input type="text" id="imei2" name="imei2" required />
        </div>

        <div class="form-group">
          <label for="modeloEquipo">Modelo del Equipo:</label>
          <select id="modeloEquipo" name="modeloEquipo" required>
            <option value="">Seleccionar modelo...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="precio">Precio (Bs.):</label>
          <input type="number" id="precio" name="precio" step="0.01" placeholder="2732.00" required />
        </div>

        <button type="submit">üéØ Generar Comprobante</button>
        <button type="button" class="pdf-button" onclick="guardarComoPDF()">üìÑ Guardar como PDF</button>
      </form>
    </div>

    <div class="preview-section">
      <h2>üëÅÔ∏è Vista Previa</h2>
      <div id="comprobante" class="comprobante">
        <!-- Header -->
        <div class="header-section">
          <div class="header-top">
            <div class="logo-company-section">
              <div class="telcel-logo">
                <img src="./images.png" alt="Telcel Logo"/>
              </div>
              <div class="company-info">
                <h3>Radiom√≥vil Dipsa, S.A. de C.V</h3>
                <div>Esquina Vicente Guerrero Con Boulevard Cuauht√©moc S/N</div>
                <div>Col. Ejidal 56604, Chalco de Diaz ‚Äì Tel: 2581 3700</div>
              </div>
            </div>
            <div class="factura-box">
              <div>FACTURA DE VENTA</div>
              <div class="nf-box"><span id="numeroFactura">FTV007-0001008</span></div>
            </div>
          </div>
          <div class="rfc-section">R.F.C RDI841003QJ4</div>
        </div>

        <!-- Cliente -->
        <div class="client-section">
          <div class="client-row">
            <div class="client-field">
              <strong>Cliente:</strong>
              <span id="clienteNombre">MARIO CHECCO VILLEGAS</span>
            </div>
            <div class="client-field">
              <strong>Fecha de emisi√≥n:</strong>
              <span id="fechaEmision">2025-06-11</span>
            </div>
          </div>

          <div class="client-row">
            <div class="client-field">
              <strong>ID CID:</strong>
              <span id="clienteDni">44179910</span>
            </div>
            <div class="client-field">
              <strong>Vendedor:</strong>
              <span>Administrador</span>
            </div>
          </div>

          <div class="client-row">
            <div class="client-field">
              <strong>Direcci√≥n:</strong>
              <span>CP - TAMBOPATA - TAMBOPATA - MADRE DE DIOS</span>
            </div>
            <div class="client-field">
              <strong>Estado:</strong>
              <span class="status-cancelled">CANCELADO</span>
            </div>
          </div>

          <div class="client-row">
            <div class="client-field">
              <strong>Tel√©fono:</strong>
              <span></span>
            </div>
            <div></div>
          </div>
        </div>

        <!-- Productos -->
        <div class="product-section">
          <table class="product-table">
            <thead>
              <tr>
                <th>CANT.</th>
                <th>UNIDAD</th>
                <th>DESCRIPCI√ìN</th>
                <th>SERIE</th>
                <th>P. UNIT</th>
                <th>DTO.</th>
                <th>TOTAL</th>
              </tr>
            </thead>
            <tbody id="productTableBody">
              <!-- Fila 1: con precio -->
              <tr id="row1">
                <td>01</td>
                <td>UNI</td>
                <td id="descripcionProducto1">HONOR 200 LITE 256GB</td>
                <td id="serieProducto1">895110163055471</td>
                <td id="precioUnitario">2,800.00</td>
                <td>0.00</td>
                <td id="totalProducto">2,800.00</td>
              </tr>
              <!-- Fila 2: referencia sin precio/total -->
              <tr id="row2" class="ref">
                <td>01</td>
                <td>UNI</td>
                <td id="descripcionProducto2">HONOR 200 LITE 256GB</td>
                <td id="serieProducto2">895110163055472</td>
                <td id="precioUnitario2"></td>
                <td></td>
                <td id="totalProducto2"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Totales -->
        <div class="totals-section">
          <div><strong>OP. EXONERADAS: Bs. <span id="totalExonerado">2,800.00</span></strong></div>
          <div><strong>TOTAL A PAGAR: Bs. <span id="totalPagar">2,800.00</span></strong></div>
        </div>

        <!-- Pagos -->
        <div class="payment-section">
          <div>
            <strong>PAGOS:</strong> - <span id="fechaPago">12/05/2025</span> - Efectivo ‚Äì Bs. <span id="montoPago">2,800.00</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- html2pdf (para descargar PDF sin encabezados/pies del navegador) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-YcsIPeJQG7YwWgdD1r9GzQ8xZz7YyQKM9JQb3o3Zq3iV2n0F4Yd9q1tYQ8v7vQO2qSmtu6mD9KJ4r8dC2r6Q7Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    // Carga de modelos
    async function cargarModelosEquipos() {
      try {
        const response = await fetch('./equipos_modelos.txt');
        const texto = await response.text();
        const modelos = texto.split('\n')
          .map(m => m.trim().toUpperCase())
          .filter(m => m.length > 0)
          .sort();

        const select = document.getElementById('modeloEquipo');
        select.innerHTML = '<option value="">Seleccionar modelo...</option>';
        modelos.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m; opt.textContent = m;
          select.appendChild(opt);
        });
      } catch (e) {
        const modelosDefault = [
          'HONOR MAGIC 7 LITE',
          'APPLE IPHONE 14 PRO MAX 1TB',
          'SAMSUNG GALAXY S23',
          'XIAOMI REDMI NOTE 12'
        ].sort();
        const select = document.getElementById('modeloEquipo');
        select.innerHTML = '<option value="">Seleccionar modelo...</option>';
        modelosDefault.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m; opt.textContent = m;
          select.appendChild(opt);
        });
      }
    }

    // Fecha aleatoria entre 15/04/2025 y 05/07/2025
    function generarFechaAleatoria() {
      const inicio = new Date('2025-04-15');
      const fin = new Date('2025-07-05');
      const t = inicio.getTime() + Math.random() * (fin.getTime() - inicio.getTime());
      return new Date(t);
    }

    function formatearFecha(fecha) {
      const y = fecha.getFullYear();
      const m = String(fecha.getMonth() + 1).padStart(2, '0');
      const d = String(fecha.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }
    function formatearFechaPago(fecha) {
      const d = String(fecha.getDate()).padStart(2, '0');
      const m = String(fecha.getMonth() + 1).padStart(2, '0');
      const y = fecha.getFullYear();
      return `${d}/${m}/${y}`;
    }
    function formatearPrecio(n) {
      return parseFloat(n).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function generarNumeroFactura() {
      const n = Math.floor(Math.random() * 9000) + 1000;
      return `FTV007-000${n}`;
    }

    // Validaciones
    const imeiRegex = /^\d{15}$/;

    function validarEntradas(dni, nombre, imei1, imei2, modelo, precio) {
      if (!dni.trim()) { alert('Ingresa el DNI/ID CID.'); return false; }
      if (!nombre.trim()) { alert('Ingresa el nombre del cliente.'); return false; }
      if (!imeiRegex.test(imei1)) { alert('IMEI 1 debe tener exactamente 15 d√≠gitos.'); return false; }
      if (!imeiRegex.test(imei2)) { alert('IMEI 2 debe tener exactamente 15 d√≠gitos.'); return false; }
      if (!modelo.trim()) { alert('Selecciona el modelo del equipo.'); return false; }
      if (isNaN(precio) || !(precio > 0)) { alert('El precio debe ser un n√∫mero mayor que 0.'); return false; }
      return true;
    }

    document.getElementById('comprobanteForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const dni = document.getElementById('dni').value.toUpperCase();
      const nombre = document.getElementById('nombreCliente').value.toUpperCase();
      const imei1 = document.getElementById('imei1').value.toUpperCase();
      const imei2 = document.getElementById('imei2').value.toUpperCase();
      const modelo = document.getElementById('modeloEquipo').value.toUpperCase();
      const precio = parseFloat(document.getElementById('precio').value);

      if (!validarEntradas(dni, nombre, imei1, imei2, modelo, precio)) return;

      const f = generarFechaAleatoria();
      const fechaEmision = formatearFecha(f);
      const fechaPago = formatearFechaPago(f);
      const numeroFactura = generarNumeroFactura();

      const total = precio;
      const precioFmt = formatearPrecio(precio);
      const totalFmt = formatearPrecio(total);

      document.getElementById('clienteNombre').textContent = nombre;
      document.getElementById('clienteDni').textContent = dni;
      document.getElementById('fechaEmision').textContent = fechaEmision;
      document.getElementById('fechaPago').textContent = fechaPago;
      document.getElementById('numeroFactura').textContent = numeroFactura;

      document.getElementById('descripcionProducto1').textContent = modelo;
      document.getElementById('serieProducto1').textContent = imei1;
      document.getElementById('precioUnitario').textContent = precioFmt;
      document.getElementById('totalProducto').textContent = precioFmt;

      document.getElementById('descripcionProducto2').textContent = modelo;
      document.getElementById('serieProducto2').textContent = imei2;
      document.getElementById('precioUnitario2').textContent = '';
      document.getElementById('totalProducto2').textContent = '';

      document.getElementById('totalExonerado').textContent = totalFmt;
      document.getElementById('totalPagar').textContent = totalFmt;
      document.getElementById('montoPago').textContent = totalFmt;

      // Suave animaci√≥n
      const comprobante = document.getElementById('comprobante');
      comprobante.style.transform = 'scale(0.98)';
      comprobante.style.transition = 'transform .3s ease';
      setTimeout(() => { comprobante.style.transform = 'scale(1)'; }, 150);
    });

    // === Seguridad: pedir contrase√±a antes de guardar ===
    async function solicitarPassword() {
      try {
        const resp = await fetch('./contras.txt', { cache: 'no-store' });
        if (!resp.ok) throw new Error('No se pudo leer contras.txt');
        const text = await resp.text();
        const validas = new Set(
          text.split(/\r?\n/)
              .map(l => l.trim())
              .filter(Boolean)
              .map(s => s.toLowerCase())
        );
        const ingreso = prompt('üîê Ingrese la contrase√±a para autorizar la exportaci√≥n a PDF:');
        if (ingreso === null) return false;          // Cancel√≥
        if (!validas.has(ingreso.trim().toLowerCase())) {
          alert('Contrase√±a incorrecta. No se gener√≥ el PDF.');
          return false;
        }
        return true;
      } catch (err) {
        alert('No se pudo validar la contrase√±a (contras.txt no accesible).');
        return false;
      }
    }

    // Utilidad: sanitizar nombre de archivo
    function sanitizarNombreArchivo(str) {
      const s = (str || 'comprobante')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')   // quita acentos
        .replace(/[^a-zA-Z0-9_-]+/g, '_')                  // espacios y raros -> _
        .replace(/^_+|_+$/g,'');                           // recorta _
      return s || 'comprobante';
    }

    // Exportar PDF con html2pdf (sin encabezados/pies del navegador)
    async function exportarPDF() {
      const elem = document.getElementById('comprobante');

      // nombre archivo: CLIENTE + NRO FACTURA
      const cliente = document.getElementById('clienteNombre').textContent.trim();
      const factura = document.getElementById('numeroFactura').textContent.trim();
      const filename = `${sanitizarNombreArchivo(cliente)}-${sanitizarNombreArchivo(factura)}.pdf`;

      // Estilos tipo "print" para ocultar bordes internos
      document.body.classList.add('exporting');

      const opt = {
        margin: 0,
        filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, letterRendering: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all','css','legacy'] }
      };

      try {
        if (typeof html2pdf !== 'undefined') {
          await html2pdf().set(opt).from(elem).save();
        } else {
          // Fallback: di√°logo de impresi√≥n del navegador (no puede fijar nombre)
          window.print();
        }
      } finally {
        document.body.classList.remove('exporting');
      }
    }

    // Bot√≥n principal: pide contrase√±a y exporta
    async function guardarComoPDF(){
      const ok = await solicitarPassword();
      if (!ok) return;
      await exportarPDF();
    }

    // Inicializaci√≥n
    window.addEventListener('load', function() {
      cargarModelosEquipos();
      const f = generarFechaAleatoria();
      const nf = generarNumeroFactura();
      document.getElementById('fechaEmision').textContent = formatearFecha(f);
      document.getElementById('fechaPago').textContent = formatearFechaPago(f);
      document.getElementById('numeroFactura').textContent = nf;
    });
  </script>
</body>
</html>
