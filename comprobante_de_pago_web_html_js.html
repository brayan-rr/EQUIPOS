<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generador de Comprobante de Pago</title>
  <!-- Tailwind (CDN) para estilos rápidos) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF y autotable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-YkG9i5F9tW5mJQ5zQmYdVYbprw1U0rF2a7Qtm8k8fHjK3Qx4d6QdQ7i1DzvYk0u9j3gq7VCUo3ZgP5nF4y4Feg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js" integrity="sha512-5RgeKm2T1aPCmwzU6d2E+VBt5+uJrW4K3WgQb9vQ4U2yY4c7m4v5g3yWq2oC8k3QpNf9qN8m8kW8mC7y7w68rQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    html { background: #0b0f19; }
  </style>
</head>
<body class="min-h-screen text-slate-100 bg-gradient-to-b from-slate-900 to-slate-800">
  <div class="mx-auto max-w-4xl p-6">
    <header class="mb-6 flex items-center justify-between">
      <h1 class="text-2xl font-bold">Generador de Comprobante de Pago</h1>
      <a class="text-xs underline opacity-70" href="#" onclick="window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'})">Ver vista previa</a>
    </header>

    <!-- FORMULARIO -->
    <section class="grid gap-4 md:grid-cols-2">
      <div class="rounded-2xl bg-slate-950/50 p-5 ring-1 ring-white/10">
        <h2 class="mb-4 text-lg font-semibold">Cuestionario</h2>
        <form id="form" class="grid gap-3">
          <div class="grid gap-1">
            <label class="text-sm">Nombre completo del cliente</label>
            <input id="nombre" class="input" placeholder="Ej. RUBEN GABRIEL ESPINOZA ZAMORA" required />
          </div>
          <div class="grid gap-1">
            <label class="text-sm">IMEI 1</label>
            <input id="imei1" class="input" placeholder="Ej. 864500073101580" required />
          </div>
          <div class="grid gap-1">
            <label class="text-sm">IMEI 2 (opcional)</label>
            <input id="imei2" class="input" placeholder="Ej. 864500073121596" />
          </div>
          <div class="grid gap-1">
            <label class="text-sm">Monto (moneda y valor)</label>
            <input id="monto" class="input" placeholder="Col$ 2,300.00" required />
          </div>
          <div class="grid gap-1">
            <label class="text-sm">Fecha</label>
            <input id="fecha" type="date" class="input" required />
          </div>
          <div class="grid gap-1">
            <label class="text-sm">Descripción del equipo</label>
            <input id="descripcion" class="input" placeholder="HONOR MAGIC7 LITE 8GB 256GB" />
          </div>
          <div class="grid gap-1">
            <label class="text-sm">Vendedor (opcional)</label>
            <input id="vendedor" class="input" placeholder="Vannia Luheme" />
          </div>
          <div class="grid gap-1">
            <label class="text-sm">Subir logo (PNG/JPG opcional)</label>
            <input id="logo" type="file" accept="image/*" class="block w-full text-sm text-slate-300 file:mr-4 file:rounded-full file:border-0 file:bg-slate-700 file:px-4 file:py-2 file:text-sm file:font-semibold hover:file:bg-slate-600" />
          </div>

          <div class="mt-2 flex gap-2">
            <button type="button" id="btn-preview" class="btn">Actualizar vista previa</button>
            <button type="button" id="btn-pdf" class="btn-primary">Generar PDF</button>
          </div>
        </form>
        <p class="mt-3 text-xs text-slate-400">* El número de factura se generará automáticamente cada vez (prefijo configurable).</p>
      </div>

      <!-- VISTA PREVIA -->
      <div class="rounded-2xl bg-white p-6 text-slate-900 shadow-lg">
        <div id="preview" class="mx-auto max-w-[700px]">
          <!-- Se llena dinámicamente -->
          <p class="text-sm text-slate-500">Completa el cuestionario y presiona <strong>Actualizar vista previa</strong>.</p>
        </div>
      </div>
    </section>

    <footer class="mt-8 text-center text-xs text-slate-400">Hecho con ❤️ – Puedes usarlo en GitHub Pages.</footer>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const fmtDate = (d) => new Intl.DateTimeFormat('es-PE', { dateStyle: 'medium' }).format(d);

    // Estilos input/botones con Tailwind clases personalizadas
    document.documentElement.classList.add('[&_.input]:bg-slate-900','[&_.input]:rounded-xl','[&_.input]:px-3','[&_.input]:py-2','[&_.input]:ring-1','[&_.input]:ring-white/10','[&_.input]:text-slate-100','[&_.btn]:rounded-xl','[&_.btn]:px-4','[&_.btn]:py-2','[&_.btn]:bg-slate-800','[&_.btn]:ring-1','[&_.btn]:ring-white/10','[&_.btn]:hover:bg-slate-700','[&_.btn-primary]:bg-indigo-600','[&_.btn-primary]:text-white','[&_.btn-primary]:hover:bg-indigo-500');

    // Prefill fecha hoy
    const today = new Date();
    $("fecha").value = today.toISOString().slice(0,10);

    // Generar número de factura aleatorio (prefijo + fecha + 4 dígitos)
    function generarNumeroFactura(prefijo = 'ADVT') {
      const d = new Date();
      const y = String(d.getFullYear()).slice(-2);
      const m = String(d.getMonth()+1).padStart(2,'0');
      const n = Math.floor(1000 + Math.random()*9000);
      return `${prefijo}-${y}${m}${n}`; // Ej: ADVT-25050876
    }

    // Cargar logo a base64
    let logoDataUrl = null;
    $("logo").addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const dataUrl = await new Promise((res) => { const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(file); });
      logoDataUrl = dataUrl;
      actualizarPreview();
    });

    function getFormData(){
      return {
        nombre: $("nombre").value.trim(),
        imei1: $("imei1").value.trim(),
        imei2: $("imei2").value.trim(),
        monto: $("monto").value.trim(),
        fecha: $("fecha").value,
        descripcion: $("descripcion").value.trim() || 'HONOR MAGIC7 LITE 8GB 256GB',
        vendedor: $("vendedor").value.trim() || '—',
      }
    }

    function plantillaHTML(data, nroFactura){
      const fechaFmt = data.fecha ? fmtDate(new Date(data.fecha)) : fmtDate(new Date());
      return `
      <div class="w-full max-w-[700px] mx-auto text-[13px]">
        <div class="flex items-center justify-between border-b pb-2">
          <div>
            <h2 class="text-xl font-semibold">MeGa77 – Tienda Virtual</h2>
            <p class="text-xs text-slate-600">Bogotá – Colombia • finanzas@megatiendavirtual77.com.co</p>
          </div>
          <div class="h-12 w-32 flex items-center justify-center border rounded">
            ${logoDataUrl ? `<img src="${logoDataUrl}" alt="logo" class="max-h-12 object-contain"/>` : '<span class="text-xs text-slate-500">Logo</span>'}
          </div>
        </div>

        <div class="mt-3 grid grid-cols-2 gap-2">
          <div>
            <p class="font-medium">BOLETA DE VENTA</p>
            <p class="text-slate-600">N°. ${nroFactura}</p>
          </div>
          <div class="text-right">
            <p><span class="text-slate-600">Fecha:</span> ${fechaFmt}</p>
            <p><span class="text-slate-600">Vendedor:</span> ${data.vendedor}</p>
          </div>
        </div>

        <div class="mt-3 grid gap-1">
          <p><span class="text-slate-600">Cliente:</span> ${data.nombre || '—'}</p>
        </div>

        <table class="mt-4 w-full border-collapse text-[12px]">
          <thead>
            <tr class="bg-slate-100 text-slate-700">
              <th class="border px-2 py-1 text-left">ÍTEM</th>
              <th class="border px-2 py-1 text-left">DESCRIPCIÓN</th>
              <th class="border px-2 py-1 text-left">IMEI</th>
              <th class="border px-2 py-1 text-right">TOTAL</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border px-2 py-1">1</td>
              <td class="border px-2 py-1">${data.descripcion}</td>
              <td class="border px-2 py-1">${[data.imei1, data.imei2].filter(Boolean).join(' / ')}</td>
              <td class="border px-2 py-1 text-right">${data.monto}</td>
            </tr>
          </tbody>
        </table>

        <div class="mt-3 flex items-center justify-between">
          <p>Total ítems: 01</p>
          <div class="rounded bg-slate-100 px-3 py-2 text-right">
            <p class="text-sm text-slate-600">TOTAL A PAGAR</p>
            <p class="text-lg font-semibold">${data.monto}</p>
          </div>
        </div>
        <p class="mt-4 text-xs text-slate-500">Pago: Se realiza pago en efectivo</p>
      </div>`;
    }

    function actualizarPreview(){
      const data = getFormData();
      const nro = generarNumeroFactura();
      $("preview").innerHTML = plantillaHTML(data, nro);
      $("preview").dataset.nro = nro; // guarda el nro usado
    }

    $("btn-preview").addEventListener('click', actualizarPreview);

    async function generarPDF(){
      const { jsPDF } = window.jspdf;
      const data = getFormData();
      const nro = $("preview").dataset.nro || generarNumeroFactura();

      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const margin = 36; // 0.5in
      let y = margin;

      // Logo
      if (logoDataUrl) {
        // ajustar ancho máximo
        const imgWidth = 120;
        const imgHeight = 40;
        doc.addImage(logoDataUrl, 'PNG', doc.internal.pageSize.getWidth() - margin - imgWidth, y, imgWidth, imgHeight);
      }

      // Encabezado
      doc.setFont('helvetica','bold');
      doc.setFontSize(14);
      doc.text('MeGa77 – Tienda Virtual', margin, y+16);
      doc.setFont('helvetica','normal');
      doc.setFontSize(10);
      doc.text('Bogotá – Colombia • finanzas@megatiendavirtual77.com.co', margin, y+32);

      // Título / Nro / Fecha
      y += 64;
      doc.setFont('helvetica','bold');
      doc.setFontSize(12);
      doc.text('BOLETA DE VENTA', margin, y);
      doc.setFont('helvetica','normal');
      doc.text(`N°. ${nro}`, margin, y+16);
      doc.text(`Fecha: ${data.fecha ? fmtDate(new Date(data.fecha)) : fmtDate(new Date())}`, margin, y+32);
      doc.text(`Vendedor: ${data.vendedor || '—'}`, margin, y+48);

      // Cliente
      y += 72;
      doc.setFont('helvetica','bold');
      doc.text('Cliente', margin, y);
      doc.setFont('helvetica','normal');
      doc.text(`${data.nombre || '—'}`, margin + 60, y);

      // Tabla
      y += 20;
      doc.autoTable({
        startY: y,
        margin: { left: margin, right: margin },
        head: [[ 'ÍTEM', 'DESCRIPCIÓN', 'IMEI', 'TOTAL' ]],
        body: [[ '1', data.descripcion, [data.imei1, data.imei2].filter(Boolean).join(' / '), data.monto ]],
        styles: { font: 'helvetica', fontSize: 10 },
        headStyles: { fillColor: [241,245,249], textColor: [51,65,85] },
        columnStyles: { 0: { cellWidth: 50 }, 1: { cellWidth: 240 }, 2: { cellWidth: 160 }, 3: { cellWidth: 80, halign: 'right' } }
      });

      y = doc.lastAutoTable.finalY + 16;
      doc.text('Total ítems: 01', margin, y);
      // Caja total a la derecha
      const pageW = doc.internal.pageSize.getWidth();
      const boxW = 180, boxH = 46;
      doc.setDrawColor(200);
      doc.setFillColor(248,250,252);
      doc.roundedRect(pageW - margin - boxW, y - 14, boxW, boxH, 6, 6, 'FD');
      doc.setFont('helvetica','normal');
      doc.setTextColor(100);
      doc.text('TOTAL A PAGAR', pageW - margin - boxW + 12, y + 2);
      doc.setFont('helvetica','bold');
      doc.setFontSize(14);
      doc.setTextColor(0);
      doc.text(String(data.monto), pageW - margin - 12, y + 22, { align: 'right' });

      // Nota de pago
      doc.setFont('helvetica','normal');
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text('Pago: Se realiza pago en efectivo', margin, y + 48);

      // Guardar
      doc.save(`comprobante_${nro}.pdf`);
    }

    $("btn-pdf").addEventListener('click', generarPDF);

    // Primera carga: preview base
    actualizarPreview();
  </script>
</body>
</html>
